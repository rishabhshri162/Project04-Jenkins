pipeline {
    agent any

    environment {
        JAVA_HOME = "C:\\Program Files\\Java\\jdk-11.0.15.1"
        PATH = "${JAVA_HOME}\\bin;${PATH}"
        TOMCAT_HOME = 'C:\\Users\\risha\\Downloads\\apache-tomcat-9.0.109-windows-x64\\apache-tomcat-9.0.109'
        TOMCAT_WEBAPPS_PATH = "${TOMCAT_HOME}\\webapps"
        TOMCAT_SERVICE_NAME = 'Tomcat9'  // Change if your service name is different
        MAVEN_HOME = "C:\\ProgramData\\Jenkins\\.jenkins\\tools\\hudson.tasks.Maven_MavenInstallation\\Maven"

    }

    stages {
        stage('Cleanup Workspace') {
            steps {
                deleteDir()
            }
        }

        stage('Clone Repository') {
            steps {
                git credentialsId: 'github-credentials', url: 'https://github.com/rishabhshri162/Project04-Jenkins.git', branch: 'main'
            }
        }

       stage('Build WAR File') {
    steps {
        bat "\"%MAVEN_HOME%\\bin\\mvn.cmd\" clean package -DskipTests -f ORSProject-04/pom.xml"
    }
}


       stage('Copy WAR to Tomcat') {
    steps {
        script {
            def warFile = "ORSProject-04\\target\\ORSProject-04.war"
            def destination = "${TOMCAT_WEBAPPS_PATH}\\ORSProject-04.war"

            // Remove old extracted folder and old WAR
            bat "rmdir /S /Q \"${TOMCAT_WEBAPPS_PATH}\\ORSProject-04\" || exit 0"
            bat "del /Q \"${TOMCAT_WEBAPPS_PATH}\\ORSProject-04.war\" || exit 0"

            // Copy new WAR
            bat "copy /Y \"${warFile}\" \"${destination}\""
        }
    }
}


        stage('Ensure Tomcat Service Exists') {
            steps {
                script {
                    def serviceExists = bat(script: "sc query ${TOMCAT_SERVICE_NAME}", returnStatus: true) == 0
                    if (!serviceExists) {
                        echo "Tomcat service not found. Installing..."
                        bat "cd /d ${TOMCAT_HOME}\\bin && service.bat install"
                    } else {
                        echo "Tomcat service already installed."
                    }
                }
            }
        }
stage('Restart Tomcat') {
    steps {
        script {
            echo "Checking Tomcat status..."

            def isRunning = bat(
                script: "sc query ${TOMCAT_SERVICE_NAME} | findstr /I \"RUNNING\"",
                returnStatus: true
            )

            if (isRunning == 0) {
                echo "Tomcat is running. Stopping..."
                bat "sc stop ${TOMCAT_SERVICE_NAME}"
                sleep time: 5, unit: 'SECONDS'
            } else {
                echo "Tomcat is NOT running. No need to stop."
            }

            echo "Starting Tomcat..."
            bat "sc start ${TOMCAT_SERVICE_NAME}"
        }
    }
}


        stage('Verify Deployment') {
            steps {
                script {
                    bat "powershell -Command \"try {Invoke-WebRequest -Uri 'http://localhost:8080/ORSProject-04' -UseBasicParsing} catch {Write-Host 'Tomcat is not reachable'}\""
                }
            }
        }
    }

    post {
        always {
            echo 'Cleaning workspace...'
            deleteDir()
        }
    }
}
